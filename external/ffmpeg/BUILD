# Per-library BUILD files live under subdirectories (lame, opus, ogg, vorbis, ffmpeg).
# Aliases are defined inside each subpackage so there are no top-level targets here.
load("@rules_foreign_cc//foreign_cc:configure.bzl", "configure_make")

configure_make(
    name = "ffmpeg",
    build_data = [
        "@nasm//:nasm",
    ],
    configure_in_place = True,
    configure_options = [
        "--disable-everything",
        "--disable-programs",
        "--enable-gpl",
        "--enable-version3",
        "--disable-doc",
        "--disable-htmlpages",
        "--disable-manpages",
        "--disable-shared",
        "--enable-network",
        "--enable-swresample",
        "--enable-avformat",
        "--enable-parsers",
        "--enable-protocols",
        "--enable-demuxer=aac",
        "--enable-demuxer=flac",
        "--enable-demuxer=mp3",
        "--enable-demuxer=mov",
        "--enable-demuxer=ogg",
        "--enable-demuxer=wav",
        # https://www.mail-archive.com/ffmpeg-devel@ffmpeg.org/msg33510.html
        "--enable-demuxer=w64",
        "--enable-muxer=adts",
        "--enable-muxer=flac",
        "--enable-muxer=mp3",
        "--enable-muxer=mp4",
        "--enable-muxer=ogg",
        "--enable-muxer=wav",
        "--enable-avcodec",
        "--enable-decoder=aac",
        "--enable-decoder=flac",
        "--enable-decoder=mp3",
        "--enable-decoder=vorbis",
        "--enable-decoder=opus",
        "--enable-decoder=pcm_s16le",
        "--enable-encoder=flac",
        "--enable-encoder=pcm_s16le",
        "--enable-filter=aresample",
        "--enable-filter=aformat",
        "--enable-filter=volume",
        "--enable-libmp3lame",
        "--enable-libopus",
        "--enable-libvorbis",
        "--enable-openssl",
        "--disable-vaapi",
        "--disable-vdpau",
        "--disable-libdrm",
        "--disable-ffnvcodec",
        "--enable-static",
    ] + select({
        "@platforms//os:windows": [
            "--toolchain=msvc",
            "--target-os=win64",
            "--arch=x86_64",
            "--extra-cflags=-I$$EXT_BUILD_DEPS/openssl/include",
            "--extra-ldflags=-LIBPATH:$$EXT_BUILD_DEPS/openssl/lib",
            "--extra-libs=\"libssl.lib libcrypto.lib ogg.lib vorbis.lib vorbisenc.lib vorbisfile.lib crypt32.lib advapi32.lib user32.lib ws2_32.lib bcrypt.lib secur32.lib shlwapi.lib\"",
            "--pkg-config=\"D:/a/_temp/msys64/usr/bin/pkg-config.exe $$BAZEL_PKG_FLAGS\"",
        ],
        "//conditions:default": [
            "--extra-libs=\"-lvorbis -lvorbisenc -lvorbisfile -logg -lm -lpthread\"",
        ],
    }),
    env = select({
        "@platforms//os:windows": {
            "PATH": "$$(dirname $(execpath @nasm//:nasm))",
            "BAZEL_PKG_FLAGS": " ".join([
                "--with-path=$$(cygpath -u $${EXT_BUILD_DEPS}/openssl/lib/pkgconfig)",
                "--with-path=$$(cygpath -u $${EXT_BUILD_DEPS}/ogg/lib/pkgconfig)",
                "--with-path=$$(cygpath -u $${EXT_BUILD_DEPS}/vorbis/lib/pkgconfig)",
                "--with-path=$$(cygpath -u $${EXT_BUILD_DEPS}/opus/lib/pkgconfig)",
            ]),
        },
        "//conditions:default": {},
    }),
    install_prefix = "build",
    lib_source = "@ffmpeg_7_0//:all_srcs",
    out_static_libs = [
        "libavcodec.a",
        "libavdevice.a",
        "libavfilter.a",
        "libavformat.a",
        "libavutil.a",
        "libswresample.a",
        "libswscale.a",
    ],
    tool_prefix = select({
        # Escape quotes for Bazel + powershell + bash: 2^4 quotes
        "@bazel_tools//src/conditions:windows": "sed -i 's|gsub(/\\\\\\\\/,|gsub(/\\\\\\\\\\\\\\\\/,|' ffbuild/config.mak &&",
        "//conditions:default": "",
    }),
    visibility = ["//visibility:public"],
    deps = [
        "//external/lame",
        "//external/ogg",
        "//external/openssl",
        "//external/opus",
        "//external/vorbis",
    ],
)

filegroup(
    name = "gen_dir",
    srcs = [":ffmpeg"],
    output_group = "gen_dir",
    visibility = ["//visibility:public"],
)
