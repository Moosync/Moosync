load("@rules_rust//cargo:defs.bzl", "cargo_build_script")
load("@rules_rust//rust:defs.bzl", "rust_binary")
load("@rules_rust_wasm_bindgen//:defs.bzl", "rust_wasm_bindgen")

package(default_visibility = ["//ui/gen_dist:__subpackages__"])

filegroup(
    name = "locales",
    srcs = glob(
        ["locales/**"],
    ),
)

filegroup(
    name = "function_details",
    srcs = ["function_details.json"],
)

filegroup(
    name = "prefs_yaml",
    srcs = ["prefs.yaml"],
)

rust_binary(
    name = "moosync_ui_bin",
    srcs = [
        "src/app.rs",
        "src/components/artist_list.rs",
        "src/components/audiostream.rs",
        "src/components/cardview.rs",
        "src/components/color_picker.rs",
        "src/components/low_img.rs",
        "src/components/mod.rs",
        "src/components/musicbar.rs",
        "src/components/musicbar_components.rs",
        "src/components/musicinfo.rs",
        "src/components/prefs/components.rs",
        "src/components/prefs/mod.rs",
        "src/components/prefs/static_components.rs",
        "src/components/provider_icon.rs",
        "src/components/sidebar.rs",
        "src/components/songdetails.rs",
        "src/components/songlist.rs",
        "src/components/songview.rs",
        "src/components/topbar.rs",
        "src/icons/add_to_library_icon.rs",
        "src/icons/add_to_queue_icon.rs",
        "src/icons/albums_icon.rs",
        "src/icons/allsongs_icon.rs",
        "src/icons/animated_equalizer_icon.rs",
        "src/icons/artists_icon.rs",
        "src/icons/cross_icon.rs",
        "src/icons/ellipsis_icon.rs",
        "src/icons/expand_icon.rs",
        "src/icons/explore_icon.rs",
        "src/icons/extensions_icon.rs",
        "src/icons/fav_icon.rs",
        "src/icons/fav_playlist_icon.rs",
        "src/icons/fetch_all_icon.rs",
        "src/icons/folder_icon.rs",
        "src/icons/genres_icon.rs",
        "src/icons/import_playlist_icon.rs",
        "src/icons/import_theme_icon.rs",
        "src/icons/logs_icon.rs",
        "src/icons/lyrics_icon.rs",
        "src/icons/mod.rs",
        "src/icons/new_playlist_icon.rs",
        "src/icons/new_theme_button_icon.rs",
        "src/icons/new_theme_icon.rs",
        "src/icons/next_icon.rs",
        "src/icons/next_track_icon.rs",
        "src/icons/paths_icon.rs",
        "src/icons/person_icon.rs",
        "src/icons/pin_icon.rs",
        "src/icons/plain_play_icon.rs",
        "src/icons/play_hover_icon.rs",
        "src/icons/play_icon.rs",
        "src/icons/playlists_icon.rs",
        "src/icons/plus_button.rs",
        "src/icons/prev_icon.rs",
        "src/icons/prev_track_icon.rs",
        "src/icons/queue_icon.rs",
        "src/icons/random_icon.rs",
        "src/icons/repeat_icon.rs",
        "src/icons/repeat_once_icon.rs",
        "src/icons/search_icon.rs",
        "src/icons/settings_icon.rs",
        "src/icons/shuffle_icon.rs",
        "src/icons/sidebar_toggle_icon.rs",
        "src/icons/song_default_icon.rs",
        "src/icons/sort_icon.rs",
        "src/icons/spotify_icon.rs",
        "src/icons/system_icon.rs",
        "src/icons/theme_view_icon.rs",
        "src/icons/themes_icon.rs",
        "src/icons/tooltip.rs",
        "src/icons/trash_icon.rs",
        "src/icons/volume_icon.rs",
        "src/main.rs",
        "src/modals/common.rs",
        "src/modals/discover_extensions.rs",
        "src/modals/login_modal.rs",
        "src/modals/mod.rs",
        "src/modals/modal_manager.rs",
        "src/modals/new_playlist_modal.rs",
        "src/modals/new_theme_modal.rs",
        "src/modals/signout_modal.rs",
        "src/modals/song_from_url_modal.rs",
        "src/modals/update_modal.rs",
        "src/pages/albums.rs",
        "src/pages/artists.rs",
        "src/pages/explore.rs",
        "src/pages/genres.rs",
        "src/pages/mod.rs",
        "src/pages/playlists.rs",
        "src/pages/search.rs",
        "src/pages/songs.rs",
        "src/players/generic.rs",
        "src/players/librespot.rs",
        "src/players/local.rs",
        "src/players/mobile.rs",
        "src/players/mod.rs",
        "src/players/rodio.rs",
        "src/store/mod.rs",
        "src/store/modal_store.rs",
        "src/store/player_store.rs",
        "src/store/provider_store.rs",
        "src/store/ui_store.rs",
        "src/utils/common.rs",
        "src/utils/context_menu.rs",
        "src/utils/db_utils.rs",
        "src/utils/entities.rs",
        "src/utils/error.rs",
        "src/utils/extensions.rs",
        "src/utils/invoke.rs",
        "src/utils/mod.rs",
        "src/utils/mpris.rs",
        "src/utils/prefs.rs",
        "src/utils/providers.rs",
        "src/utils/songs.rs",
        "src/utils/tracing_writer.rs",
        "src/utils/window.rs",
        "src/utils/yt_player.rs",
    ],
    compile_data = [
        "Cargo.toml",
    ],
    platform = "@rules_rust//rust/platform:wasm",
    rustc_flags = [
        # Don't want a 700mb binary even in debug
        "-C",
        "opt-level=z",
        "-C",
        "panic=abort",
        "-C",
        "strip=symbols",
    ],
    deps = [
        ":build_script",
        "//core/types:types_ui",
        "@wasmCrates//:bitcode",
        "@wasmCrates//:chrono",
        "@wasmCrates//:colors-transform",
        "@wasmCrates//:console_error_panic_hook",
        "@wasmCrates//:dyn-clone",
        "@wasmCrates//:futures",
        "@wasmCrates//:indexed_db_futures",
        "@wasmCrates//:itertools",
        "@wasmCrates//:js-sys",
        "@wasmCrates//:lazy_static",
        "@wasmCrates//:leptos",
        "@wasmCrates//:leptos-use",
        "@wasmCrates//:leptos_context_menu",
        "@wasmCrates//:leptos_dom",
        "@wasmCrates//:leptos_i18n",
        "@wasmCrates//:leptos_meta",
        "@wasmCrates//:leptos_router",
        "@wasmCrates//:leptos_virtual_scroller",
        "@wasmCrates//:rand",
        "@wasmCrates//:serde",
        "@wasmCrates//:serde-wasm-bindgen",
        "@wasmCrates//:serde_json",
        "@wasmCrates//:tokio",
        "@wasmCrates//:tracing",
        "@wasmCrates//:tracing-subscriber",
        "@wasmCrates//:url-escape",
        "@wasmCrates//:uuid",
        "@wasmCrates//:wasm-bindgen",
        "@wasmCrates//:wasm-bindgen-futures",
        "@wasmCrates//:wasm-timer",
        "@wasmCrates//:web-sys",
    ],
)

cargo_build_script(
    name = "build_script",
    srcs = ["build.rs"],
    compile_data = ["Cargo.toml"],
    crate_root = "build.rs",
    data = [
        "Cargo.toml",
        ":function_details",
        ":locales",
        ":prefs_yaml",
    ],
    visibility = ["//visibility:public"],
    deps = [
        "//tauri-invoke-proc:tauri_invoke_proc_ui",
        "//ui/leptos/src/pref_gen",
        "@wasmCrates//:leptos_i18n_build",
    ],
)

rust_wasm_bindgen(
    name = "moosync_ui_bindgen",
    bindgen_flags = [
        "--no-typescript",
    ],
    out_name = "moosync_ui_bindgen",
    target = "web",
    wasm_file = ":moosync_ui_bin",
)
